// ==UserScript==
// @name         Anti-DPI Advanced v2.0 (with Config, CDN & Service Worker)
// @namespace    http://tampermonkey.net/
// @version      2.0
// @description  GÃ¢y nhiá»…u DPI báº±ng headers giáº£, request ngáº«u nhiÃªn, Service Worker, cáº­p nháº­t CDN vÃ  UI cáº¥u hÃ¬nh trong Tampermonkey.
// @author       You
// @match        *://*/*
// @grant        GM_xmlhttpRequest
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_registerMenuCommand
// @run-at       document-end
// ==/UserScript==

(function () {
    'use strict';

    // ========== âš™ï¸ UI Cáº¥u hÃ¬nh ==========
    const configDefaults = {
        requestCount: 10,
        interval: 30000, // 30 giÃ¢y
        cdnUrl: 'https://cdn.jsdelivr.net/gh/user/repo/noise-domains.json',
        enableSW: true
    };

    // Äá»c cáº¥u hÃ¬nh tá»« bá»™ nhá»›
    const config = {
        requestCount: GM_getValue('requestCount', configDefaults.requestCount),
        interval: GM_getValue('interval', configDefaults.interval),
        cdnUrl: GM_getValue('cdnUrl', configDefaults.cdnUrl),
        enableSW: GM_getValue('enableSW', configDefaults.enableSW)
    };

    // Menu chá»‰nh cáº¥u hÃ¬nh
    GM_registerMenuCommand("âš™ï¸ Cáº¥u hÃ¬nh Anti-DPI", async () => {
        const req = prompt("Sá»‘ request gÃ¢y nhiá»…u má»—i láº§n (máº·c Ä‘á»‹nh 10):", config.requestCount);
        const delay = prompt("Khoáº£ng cÃ¡ch giá»¯a cÃ¡c Ä‘á»£t (ms) (máº·c Ä‘á»‹nh 30000):", config.interval);
        const cdn = prompt("URL CDN chá»©a danh sÃ¡ch domain gÃ¢y nhiá»…u:", config.cdnUrl);
        const sw = confirm("Báº¡n cÃ³ muá»‘n kÃ­ch hoáº¡t Service Worker redirect?");
        GM_setValue('requestCount', parseInt(req) || configDefaults.requestCount);
        GM_setValue('interval', parseInt(delay) || configDefaults.interval);
        GM_setValue('cdnUrl', cdn || configDefaults.cdnUrl);
        GM_setValue('enableSW', sw);
        alert("âœ… ÄÃ£ lÆ°u cáº¥u hÃ¬nh. Reload trang Ä‘á»ƒ Ã¡p dá»¥ng.");
    });

    // ========== ðŸ“¦ Cáº¥u trÃºc dá»¯ liá»‡u ==========
    const userAgents = [
        'Mozilla/5.0 (Windows NT 10.0; Win64; x64)...',
        'Mozilla/5.0 (Macintosh; Intel Mac OS X)...',
        'Mozilla/5.0 (X11; Linux x86_64)...',
        'Mozilla/5.0 (iPhone; CPU iPhone OS)...'
    ];

    const customHeaders = {
        'Accept': [...],
        'Accept-Language': [...],
        'Referer': [...],
        'Origin': [...],
        'Cache-Control': [...],
        'Connection': [...]
    };

    const methods = ['GET', 'POST', 'HEAD', 'OPTIONS'];
    let noiseDomains = [];

    // ========== ðŸŒ Táº£i danh sÃ¡ch domain tá»« CDN ==========
    function fetchNoiseDomainsFromCDN() {
        GM_xmlhttpRequest({
            method: 'GET',
            url: config.cdnUrl + '?_=' + Date.now(),
            onload: res => {
                try {
                    const data = JSON.parse(res.responseText);
                    noiseDomains = data.domains || [];
                    console.log('[Anti-DPI] Noise domains loaded:', noiseDomains);
                } catch (e) {
                    console.warn('âŒ Lá»—i phÃ¢n tÃ­ch JSON noiseDomains:', e);
                }
            },
            onerror: err => console.warn('âŒ KhÃ´ng thá»ƒ táº£i CDN:', err)
        });
    }

    // ========== ðŸ§  Utilities ==========
    function getRandomItem(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    function generateHeaders() {
        return {
            'User-Agent': getRandomItem(userAgents),
            'Accept': getRandomItem(customHeaders.Accept),
            'Accept-Language': getRandomItem(customHeaders['Accept-Language']),
            'Referer': getRandomItem(customHeaders.Referer),
            'Origin': getRandomItem(customHeaders.Origin),
            'Cache-Control': getRandomItem(customHeaders['Cache-Control']),
            'Connection': getRandomItem(customHeaders.Connection),
            'X-Custom-Header': 'Noise-' + Math.random().toString(36).substring(2)
        };
    }

    function sendFakeRequest(method, url) {
        GM_xmlhttpRequest({
            method,
            url: config.enableSW ? redirectViaSW(url) : url,
            headers: generateHeaders(),
            data: method === 'POST' ? JSON.stringify({ junk: Math.random() }) : null,
            onload: res => console.log(`[${method}] ${url} =>`, res.status),
            onerror: err => console.error(`[${method}] Error:`, err)
        });
    }

    function redirectViaSW(url) {
        // ÄÃ¡nh dáº¥u URL Ä‘á»ƒ SW nháº­n biáº¿t vÃ  xá»­ lÃ½
        return url + (url.includes('?') ? '&' : '?') + 'antiDPI=' + Math.random().toString(36).substring(7);
    }

    // ========== ðŸ–¼ï¸ GÃ¢y nhiá»…u DOM ==========
    function insertHiddenIframes() {
        if (!noiseDomains.length) return;
        noiseDomains.forEach(domain => {
            const iframe = document.createElement('iframe');
            iframe.src = redirectViaSW(domain);
            iframe.style = 'display:none;width:0;height:0;';
            document.body.appendChild(iframe);

            const img = document.createElement('img');
            img.src = redirectViaSW(domain + '?img=' + Math.random());
            img.style = 'width:1px;height:1px;position:absolute;left:-9999px;';
            document.body.appendChild(img);
        });
    }

    function scheduleNoise() {
        for (let i = 0; i < config.requestCount; i++) {
            const method = getRandomItem(methods);
            const url = getRandomItem(noiseDomains);
            if (url) sendFakeRequest(method, url);
        }
    }

    // ========== ðŸš€ Main ==========
    window.addEventListener('load', () => {
        if (location.protocol !== 'https:') return console.warn('âš ï¸ HTTPS khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng.');
        fetchNoiseDomainsFromCDN();
        setTimeout(() => {
            insertHiddenIframes();
            scheduleNoise();
            setInterval(scheduleNoise, config.interval);
        }, 3000);
    });

})();
